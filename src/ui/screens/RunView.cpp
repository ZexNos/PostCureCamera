#include "ui/screens/RunView.h"
#include <pgmspace.h>

// ----------------------------------------------------------
// 42×42 BITMAPS (1 bpp)
// ----------------------------------------------------------

// SETTINGS
static const uint8_t PROGMEM ICON_SETTINGS_42[] = {
    0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xfc,
    0x7f, 0x0f, 0xff, 0xc0, 0xff, 0xf0, 0x3e, 0x07, 0xff, 0xc0, 0xff, 0xf0, 0x3e, 0x07, 0xff, 0xc0,
    0xff, 0xf0, 0x00, 0x07, 0xff, 0xc0, 0xff, 0xf8, 0x00, 0x0f, 0xff, 0xc0, 0xff, 0xf8, 0x00, 0x0f,
    0xff, 0xc0, 0xff, 0xf0, 0x00, 0x07, 0xff, 0xc0, 0xff, 0xe0, 0x00, 0x03, 0xff, 0xc0, 0xfc, 0x00,
    0x00, 0x00, 0x0f, 0xc0, 0xf8, 0x00, 0x1e, 0x00, 0x0f, 0xc0, 0xf8, 0x00, 0x7f, 0x80, 0x07, 0xc0,
    0xf0, 0x01, 0xff, 0xc0, 0x07, 0xc0, 0xf8, 0x01, 0xff, 0xe0, 0x0f, 0xc0, 0xfe, 0x03, 0xff, 0xe0,
    0x3f, 0xc0, 0xff, 0x03, 0xff, 0xe0, 0x7f, 0xc0, 0xff, 0x03, 0xff, 0xf0, 0x7f, 0xc0, 0xff, 0x03,
    0xff, 0xf0, 0x7f, 0xc0, 0xff, 0x03, 0xff, 0xf0, 0x7f, 0xc0, 0xfe, 0x03, 0xff, 0xe0, 0x3f, 0xc0,
    0xf8, 0x01, 0xff, 0xe0, 0x0f, 0xc0, 0xf8, 0x01, 0xff, 0xc0, 0x07, 0xc0, 0xf8, 0x00, 0x7f, 0x80,
    0x07, 0xc0, 0xf8, 0x00, 0x1e, 0x00, 0x0f, 0xc0, 0xfc, 0x00, 0x00, 0x00, 0x0f, 0xc0, 0xff, 0xe0,
    0x00, 0x03, 0xff, 0xc0, 0xff, 0xf0, 0x00, 0x07, 0xff, 0xc0, 0xff, 0xf8, 0x00, 0x07, 0xff, 0xc0,
    0xff, 0xf8, 0x00, 0x07, 0xff, 0xc0, 0xff, 0xf8, 0x00, 0x07, 0xff, 0xc0, 0xff, 0xf0, 0x3e, 0x07,
    0xff, 0xc0, 0xff, 0xf0, 0x3f, 0x07, 0xff, 0xc0, 0xff, 0xfc, 0x7f, 0x0f, 0xff, 0xc0, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0
};


// UV
static const uint8_t PROGMEM ICON_UV_42[] = {
    0xff,0xff,0xff,0xff,0xff,0xc0, 0xff,0xff,0xff,0xff,0xff,0xc0, 0xff,0xff,0xf7,0xff,0xff,0xc0,
    0xff,0xff,0xe7,0xff,0xff,0xc0, 0xff,0xff,0xe7,0xff,0xff,0xc0, 0xff,0xff,0xe7,0xff,0xff,0xc0,
    0xff,0xff,0xe7,0xff,0xff,0xc0, 0xfe,0xff,0xe7,0xff,0x7f,0xc0, 0xfe,0x7f,0xf7,0xfe,0x3f,0xc0,
    0xff,0x3f,0xff,0xfc,0x7f,0xc0, 0xff,0x8f,0xe7,0xf8,0xff,0xc0, 0xff,0xcf,0x00,0x71,0xff,0xc0,
    0xff,0xfc,0x00,0x3b,0xff,0xc0, 0xff,0xf8,0x00,0x0f,0xff,0xc0, 0xff,0xf0,0x00,0x0f,0xff,0xc0,
    0xff,0xe0,0x00,0x07,0xff,0xc0, 0xff,0xe0,0x00,0x03,0xff,0xc0, 0xff,0xc0,0x00,0x03,0xff,0xc0,
    0xff,0xc1,0x14,0x43,0xff,0xc0, 0xff,0xc1,0x14,0x41,0xff,0xc0, 0x80,0xc1,0x12,0x81,0x81,0xc0,
    0xc0,0xc1,0x12,0x81,0x81,0xc0,  0xff,0xc1,0x33,0x81,0xff,0xc0, 0xff,0xc0,0xe1,0x03,0xff,0xc0,
    0xff,0xc0,0x00,0x03,0xff,0xc0, 0xff,0xe0,0x00,0x03,0xff,0xc0, 0xff,0xe0,0x00,0x07,0xff,0xc0,
    0xff,0xf0,0x00,0x0f,0xff,0xc0, 0xff,0xf8,0x00,0x1f,0xff,0xc0, 0xff,0xcc,0x00,0x3b,0xff,0xc0,
    0xff,0x8f,0x00,0xf9,0xff,0xc0, 0xff,0x1f,0xff,0xfc,0xff,0xc0, 0xfe,0x3f,0xff,0xfe,0x7f,0xc0,
    0xfe,0x7f,0xf7,0xff,0x3f,0xc0, 0xfe,0xff,0xe7,0xff,0xff,0xc0, 0xff,0xff,0xe7,0xff,0xff,0xc0,
    0xff,0xff,0xe7,0xff,0xff,0xc0, 0xff,0xff,0xe7,0xff,0xff,0xc0, 0xff,0xff,0xe7,0xff,0xff,0xc0,
    0xff,0xff,0xf7,0xff,0xff,0xc0, 0xff,0xff,0xff,0xff,0xff,0xc0
};

// DRY
static const uint8_t PROGMEM ICON_DRY_42[] = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xc0, 0xff, 0xfd, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xfc, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xf8, 
	0x7f, 0xff, 0xff, 0xc0, 0xff, 0xf0, 0x3f, 0xff, 0xff, 0xc0, 0xff, 0xe0, 0x1f, 0xff, 0xff, 0xc0, 
	0xff, 0xe3, 0x1f, 0xff, 0xff, 0xc0, 0xff, 0xc7, 0x8f, 0xff, 0xff, 0xc0, 0xff, 0x8f, 0x87, 0xff, 
	0xff, 0xc0, 0xff, 0x8f, 0xcf, 0xff, 0xff, 0xc0, 0xff, 0x1f, 0xff, 0xff, 0xff, 0xc0, 0xfe, 0x3f, 
	0xff, 0xf8, 0x07, 0xc0, 0xfe, 0x3e, 0xff, 0xe0, 0x01, 0xc0, 0xfc, 0x7c, 0x1f, 0x00, 0x00, 0xc0, 
	0xfc, 0x7e, 0x00, 0x07, 0xf8, 0xc0, 0xf8, 0xff, 0x80, 0x1f, 0xff, 0xc0, 0xf1, 0xff, 0xf1, 0xff, 
	0xff, 0xc0, 0xf1, 0xff, 0xff, 0xfe, 0x1f, 0xc0, 0xe3, 0xff, 0xff, 0xf0, 0x03, 0xc0, 0xe3, 0xfc, 
	0x7f, 0xc0, 0x00, 0xc0, 0xe3, 0xfc, 0x00, 0x03, 0xf0, 0xc0, 0xc7, 0xfe, 0x00, 0x0f, 0xff, 0xc0, 
	0xc7, 0xff, 0xc0, 0x7f, 0xff, 0xc0, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xc7, 0xff, 0xff, 0xf0, 
	0x03, 0xc0, 0xc7, 0xfc, 0x7f, 0xe0, 0x00, 0xc0, 0xc7, 0xfc, 0x0e, 0x01, 0xf0, 0xc0, 0xe7, 0xfe, 
	0x00, 0x0f, 0xfc, 0xc0, 0xe3, 0xff, 0x80, 0x3f, 0xff, 0xc0, 0xe3, 0xff, 0xff, 0xff, 0xff, 0xc0, 
	0xf1, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xfc, 0x3f, 0xff, 0xff, 
	0xff, 0xc0, 0xfc, 0x0f, 0xc7, 0xff, 0xff, 0xc0, 0xff, 0x00, 0x07, 0xff, 0xff, 0xc0, 0xff, 0xc0, 
	0x0f, 0xff, 0xff, 0xc0, 0xff, 0xf8, 0x7f, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0
};

// ----------------------------------------------------------
// UI GEOMETRY
// ----------------------------------------------------------

static const int16_t BTN_W     = 50;
static const int16_t BTN_H     = 50;
static const int16_t BTN_RADIUS= 4;

static const int16_t BTN_X0 = 2;
static const int16_t BTN_X1 = BTN_X0 + BTN_W + 3;
static const int16_t BTN_X2 = BTN_X1 + BTN_W + 3;

static const int16_t BTN_Y =
    UI_BAR_H + ((UI_H - UI_BAR_H - (BTN_H + 12)) / 2);


// ----------------------------------------------------------

void RunView::begin(DisplayST7789* tft) {
    _tft = tft;
    _selected = 0;
}

void RunView::drawStatic() {
    _tft->clearBody();
    drawButtons();
    drawLabels();
}

void RunView::setSelected(uint8_t index) {
    if (index > 2) index = 2;

    if (_selected == index) {
        return;
    }

    uint8_t prev = _selected;
    _selected = index;

    if (prev <= 2) {
        drawButton(prev, false);
    }
    if (_selected <= 2) {
        drawButton(_selected, true);
    }
}


// ----------------------------------------------------------
// BUTTON DRAW
// ----------------------------------------------------------

void RunView::drawButtons() {
    drawButton(0, _selected == 0);
    drawButton(1, _selected == 1);
    drawButton(2, _selected == 2);
}

void RunView::drawButton(uint8_t index, bool active) {
    auto& g = _tft->gfx();

    int16_t x = (index == 0 ? BTN_X0 : (index == 1 ? BTN_X1 : BTN_X2));
    int16_t y = BTN_Y;

    // выбираем иконку и её "акцентный" цвет
    const uint8_t* bmp = nullptr;
    uint16_t accentColor = COL_LINE;   // базово серый

    switch (index) {
        case 0: // CURE (UV)
            bmp         = ICON_UV_42;
            accentColor = COL_UV;      // фиолетовый
            break;

        case 1: // DRY
            bmp         = ICON_DRY_42;
            accentColor = COL_WARN;    // оранжевый
            break;

        case 2: // SETTINGS
        default:
            bmp         = ICON_SETTINGS_42;
            accentColor = COL_ACCENT;    // оставляем серой даже в активе
            break;
    }

	// Кнопка ВСЕГДА своей темы
	const uint16_t btnColor   = accentColor;  

	// Рамка: активная — светло-серая, неактивная — тёмно-серая
	const uint16_t borderColor = active ? COL_TEXT : COL_BTN_BG_ACTIVE;

	// Иконка всегда тем же цветом, что и кнопка
	const uint16_t iconColor   = btnColor;

    // Фон кнопки — всегда один и тот же, без подсветки
    g.fillRoundRect(x, y, BTN_W, BTN_H, BTN_RADIUS, COL_BTN_BG);

    // Контур 1 px цветом borderColor
    g.drawRoundRect(x, y, BTN_W, BTN_H, BTN_RADIUS, borderColor);

    // Центруем иконку 42x42 внутри 50x50
    int16_t iconX = x + (BTN_W - 42) / 2;
    int16_t iconY = y + (BTN_H - 42) / 2;

    // Рисуем иконку тем же цветом, что и рамка
    drawIconBitmap42(iconX, iconY, bmp, iconColor);
}


// ----------------------------------------------------------
// LABELS
// ----------------------------------------------------------

void RunView::drawLabels() {
    auto& g = _tft->gfx();

    const char* labels[3] = { "CURE", "DRY", "SET" };
    int16_t xs[3] = { BTN_X0, BTN_X1, BTN_X2 };

    int16_t labelY = BTN_Y + BTN_H + 8;

    g.setTextSize(1);
    g.setTextColor(COL_LINE);

    for (uint8_t i = 0; i < 3; i++) {
        const char* txt = labels[i];
        uint8_t len = strlen(txt);

        int16_t w = len * 6; // size=1

        int16_t x = xs[i] + (BTN_W - w) / 2;

        g.fillRect(xs[i], labelY - 2, BTN_W, 10, COL_BG);
        g.setCursor(x, labelY);
        g.print(txt);
    }
}


// ----------------------------------------------------------
// 1bpp BITMAP BLIT
// ----------------------------------------------------------

void RunView::drawIconBitmap42(int16_t x, int16_t y,
                               const uint8_t* data,
                               uint16_t color)
{
    auto& g = _tft->gfx();

    const uint8_t W     = 42;
    const uint8_t H     = 42;
    const uint8_t BYTES = (W + 7) / 8;

    for (uint8_t row = 0; row < H; row++) {
        for (uint8_t cb = 0; cb < BYTES; cb++) {
            uint8_t b = pgm_read_byte(&data[row * BYTES + cb]);

            for (uint8_t bit = 0; bit < 8; bit++) {
                if (b & (0x80 >> bit)) continue;   // 0 = рисуем, 1 = фон
                int16_t px = x + cb * 8 + bit;
                if (px >= x + W) continue;
                g.drawPixel(px, y + row, color);
            }
        }
    }
}
