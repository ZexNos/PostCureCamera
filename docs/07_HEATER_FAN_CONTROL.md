# Heater & Fan Control — Contracts and Behaviour

Этот документ определяет единый контракт управления нагревателем (PTC Heater) и вентилятором теплообдува (fan_heater).  
Логика используется всеми режимами (CURE, DRY, UVLOCK, PURGE) и является частью Core-слоя.

---

# 1. PWM Contract Table

| Heater PWM | Fan PWM | Примечание |
|-----------:|--------:|------------|
| 0          | 0       | Полный стоп (камера остывшая) |
| 10         | 40      | Минимальный поток для продува нагревателя |
| 40         | 40      | Нижний порог линейной зоны |
| 55         | 55      | Старт прямой зависимости |
| 100        | 100     | Максимум обдува |

---

# 2. Behaviour by System State

| Состояние | fan_heater_pwm | Комментарий |
|-----------|----------------|-------------|
| Heater = 0, ТЭН холодный | 0 % | Остановка вентилятора |
| Heater = 0, ТЭН горячий | 40 % на 30–60 с | After-cool (послеобдув) |
| Heater PWM < 40 % | 40 % | Минимальный поток для защиты PTC |
| Heater PWM ≥ 40 % | = Heater PWM | Прямая зависимость |
| OverTemp / DoorOpen | ≥ 40 % … 100 % | Принудительный обдув |
| Режим PURGE | 100 % | Продувка камеры без нагрева |

---

# 3. Safety Logic

- Вентилятор **не запитан от одного реле с нагревателем**.  
  Это позволяет обдув при `heater_pwm = 0`.
- При `OverTemp_TEN` → Heater = OFF, Fan = 100 % до нормализации.
- При `DoorOpen` → Heater = OFF, Fan ≥ 40 %.
- При `SensorFault(DS18B20)` → Heater = OFF, Fan ≥ 40 %.
- При переходе из активности в idle → Fan = 40 % ещё 30–60 с.

---

# 4. Dynamic Rules

- Slew-rate: изменение PWM не быстрее **±15 %/с**.
- Минимальное время удержания уровня: **≥ 3 с**.
- After-cool: **30–60 с** после отключения нагрева (если ТЭН был горячим).
- Линейная зона начинается на PWM ≥ 40 %.

---

# 5. Integration Notes

- Fan не включён в PID — он вспомогательный (thermal safety).
- PID регулирует только нагреватель через SSR.
- Exhaust-fan управляется отдельно и не входит в эту модель.
- Логика универсальна и применяется всеми режимами (CURE, DRY_FILAMENT, UVLOCK, PURGE).

---

# 6. Future Expansion

- Возможность привязать fan_heater к прогнозируемой температуре (feed-forward).
- Добавление under-table airflow zone.
- Двухкоординатная модель «нагрев — охлаждение» для крупного объёма камеры.

